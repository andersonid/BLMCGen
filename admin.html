<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - BLMCGen</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }

        /* --- Top bar --- */
        .topbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .topbar h1 { font-size: 1.25rem; font-weight: 600; }
        .topbar-actions { display: flex; gap: 0.75rem; align-items: center; }
        .topbar-actions span { font-size: 0.85rem; opacity: 0.9; }
        .topbar-actions a,
        .topbar-actions button {
            background: rgba(255,255,255,.2);
            color: #fff;
            border: none;
            padding: 0.4rem 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            text-decoration: none;
            transition: background .2s;
        }
        .topbar-actions a:hover,
        .topbar-actions button:hover { background: rgba(255,255,255,.35); }

        /* --- Layout --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

        /* --- Stat cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
        }
        .stat-card .label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: .5px; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; margin-top: .25rem; color: #667eea; }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 1.25rem;
        }
        .tab-btn {
            padding: 0.6rem 1.25rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: color .2s, border-color .2s;
        }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* --- Table --- */
        .panel-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
            overflow: hidden;
        }
        .panel-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: .75rem;
        }
        .panel-header h2 { font-size: 1.1rem; }
        .search-box {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            width: 260px;
            max-width: 100%;
        }
        .search-box:focus { outline: none; border-color: #667eea; }

        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.65rem 1rem; font-size: 0.9rem; }
        th { background: #fafafa; color: #666; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: .4px; }
        tr:not(:last-child) td { border-bottom: 1px solid #f0f0f0; }
        tr:hover td { background: #f8f9ff; }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.55rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-green { background: #d4edda; color: #155724; }
        .badge-red   { background: #f8d7da; color: #721c24; }
        .badge-blue  { background: #d0e3ff; color: #1a3f6f; }
        .badge-gray  { background: #e9ecef; color: #495057; }

        .actions-cell { display: flex; gap: .4rem; flex-wrap: wrap; }
        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.78rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity .2s;
        }
        .btn-sm:hover { opacity: .85; }
        .btn-primary  { background: #667eea; color: #fff; }
        .btn-warning  { background: #ffc107; color: #333; }
        .btn-danger   { background: #dc3545; color: #fff; }
        .btn-success  { background: #28a745; color: #fff; }

        /* --- Pagination --- */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: .5rem;
            padding: 1rem;
        }
        .pagination button {
            padding: 0.35rem 0.75rem;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .pagination button.active { background: #667eea; color: #fff; border-color: #667eea; }
        .pagination button:disabled { opacity: .4; cursor: default; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: #fff;
            border-radius: 10px;
            width: 95%;
            max-width: 480px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,.2);
        }
        .modal h3 { margin-bottom: 1rem; }
        .modal .form-group { margin-bottom: .85rem; }
        .modal label { display: block; margin-bottom: .3rem; font-weight: 500; font-size: .9rem; }
        .modal input, .modal select {
            width: 100%;
            padding: .55rem .7rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: .9rem;
        }
        .modal-actions { display: flex; gap: .5rem; justify-content: flex-end; margin-top: 1.25rem; }
        .modal-actions button { padding: .5rem 1rem; border-radius: 5px; border: none; cursor: pointer; font-size: .9rem; }
        .btn-cancel { background: #e9ecef; color: #333; }
        .btn-confirm { background: #667eea; color: #fff; }

        /* --- Roles tab --- */
        .role-card { background: #fff; border-radius: 8px; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); margin-bottom: 1rem; }
        .role-card h3 { font-size: 1rem; margin-bottom: .25rem; }
        .role-card p { font-size: .85rem; color: #666; margin-bottom: .75rem; }
        .perm-list { display: flex; flex-wrap: wrap; gap: .35rem; }

        /* --- Toast --- */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
            box-shadow: 0 4px 16px rgba(0,0,0,.18);
            z-index: 2000;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity .3s, transform .3s;
        }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast-success { background: #28a745; }
        .toast-error   { background: #dc3545; }

        .hidden { display: none !important; }

        /* --- Loading spinner --- */
        .spinner {
            display: inline-block;
            width: 18px; height: 18px;
            border: 2px solid #667eea;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin .6s linear infinite;
            vertical-align: middle;
            margin-right: .4rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .search-box { width: 100%; }
            table { font-size: .82rem; }
            th, td { padding: .5rem .6rem; }
        }
    </style>
</head>
<body>

<div class="topbar">
    <h1>BLMCGen Admin</h1>
    <div class="topbar-actions">
        <span id="currentUser"></span>
        <a href="/">App</a>
        <button onclick="logout()">Sair</button>
    </div>
</div>

<div class="container">
    <!-- Stats -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="users">Usuarios</button>
        <button class="tab-btn" data-tab="canvas">Canvas</button>
        <button class="tab-btn" data-tab="roles">Roles</button>
    </div>

    <!-- Users panel -->
    <div class="tab-panel active" id="panel-users">
        <div class="panel-card">
            <div class="panel-header">
                <h2>Usuarios cadastrados</h2>
                <input class="search-box" id="userSearch" placeholder="Buscar por nome ou email..." />
            </div>
            <div style="overflow-x:auto">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Verificado</th>
                            <th>Status</th>
                            <th>Criado em</th>
                            <th>Acoes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="usersPagination"></div>
        </div>
    </div>

    <!-- Canvas panel -->
    <div class="tab-panel" id="panel-canvas">
        <div class="panel-card">
            <div class="panel-header">
                <h2>Todos os canvas</h2>
                <input class="search-box" id="canvasSearch" placeholder="Buscar por titulo ou autor..." />
            </div>
            <div style="overflow-x:auto">
                <table>
                    <thead>
                        <tr>
                            <th>Titulo</th>
                            <th>Tipo</th>
                            <th>Autor</th>
                            <th>Publico</th>
                            <th>Atualizado</th>
                            <th>Acoes</th>
                        </tr>
                    </thead>
                    <tbody id="canvasTableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="canvasPagination"></div>
        </div>
    </div>

    <!-- Roles panel -->
    <div class="tab-panel" id="panel-roles">
        <div id="rolesContainer"></div>
    </div>
</div>

<!-- Edit user modal -->
<div class="modal-overlay" id="editUserModal">
    <div class="modal">
        <h3>Editar usuario</h3>
        <input type="hidden" id="editUserId" />
        <div class="form-group">
            <label for="editUserName">Nome</label>
            <input id="editUserName" />
        </div>
        <div class="form-group">
            <label for="editUserEmail">Email</label>
            <input id="editUserEmail" type="email" />
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('editUserModal')">Cancelar</button>
            <button class="btn-confirm" onclick="saveUser()">Salvar</button>
        </div>
    </div>
</div>

<!-- Manage roles modal -->
<div class="modal-overlay" id="rolesModal">
    <div class="modal">
        <h3>Gerenciar roles</h3>
        <input type="hidden" id="rolesUserId" />
        <div id="rolesCheckboxes"></div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('rolesModal')">Cancelar</button>
            <button class="btn-confirm" onclick="saveRoles()">Salvar</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const API = '/api/admin';
let token = localStorage.getItem('bmcgen_auth_token');
let allRoles = [];

// -- Helpers ------------------------------------------------------------------

function headers() {
    return { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
}

async function api(path, opts = {}) {
    const res = await fetch(`${API}${path}`, { headers: headers(), ...opts });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Request failed');
    return data;
}

function toast(msg, type = 'success') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = `toast toast-${type} visible`;
    setTimeout(() => el.classList.remove('visible'), 3000);
}

function fmtDate(iso) {
    if (!iso) return '-';
    return new Date(iso).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
function openModal(id)  { document.getElementById(id).classList.add('visible'); }

// -- Auth guard ---------------------------------------------------------------

async function checkAdmin() {
    if (!token) return goLogin();
    try {
        const res = await fetch('/api/auth/me', { headers: headers() });
        if (!res.ok) return goLogin();
        const { data } = await res.json();
        const user = data.user;
        document.getElementById('currentUser').textContent = user.name;

        // Also try to hit admin stats to confirm permissions
        await api('/stats');
    } catch {
        toast('Sem permissao de admin', 'error');
        setTimeout(() => { window.location.href = '/'; }, 1500);
    }
}

function goLogin() { window.location.href = '/login'; }
function logout() {
    localStorage.removeItem('bmcgen_auth_token');
    localStorage.removeItem('bmcgen_user');
    goLogin();
}

// -- Stats --------------------------------------------------------------------

async function loadStats() {
    try {
        const { data } = await api('/stats');
        const grid = document.getElementById('statsGrid');
        grid.innerHTML = `
            <div class="stat-card"><div class="label">Usuarios</div><div class="value">${data.users.total}</div></div>
            <div class="stat-card"><div class="label">Verificados</div><div class="value">${data.users.verified}</div></div>
            <div class="stat-card"><div class="label">Ativos</div><div class="value">${data.users.active}</div></div>
            <div class="stat-card"><div class="label">Novos (30d)</div><div class="value">${data.users.recentSignups}</div></div>
            <div class="stat-card"><div class="label">Canvas total</div><div class="value">${data.canvas.total}</div></div>
            <div class="stat-card"><div class="label">Canvas publicos</div><div class="value">${data.canvas.public}</div></div>
        `;
    } catch (e) {
        console.error('Stats error', e);
    }
}

// -- Users --------------------------------------------------------------------

let usersPage = 1;
let usersSearch = '';
let searchTimeout;

async function loadUsers(page = 1) {
    usersPage = page;
    try {
        const params = new URLSearchParams({ page, limit: 15 });
        if (usersSearch) params.set('search', usersSearch);
        const { data } = await api(`/users?${params}`);
        renderUsersTable(data.users);
        renderPagination('usersPagination', data.pagination, loadUsers);
    } catch (e) {
        toast(e.message, 'error');
    }
}

function renderUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#888;padding:2rem">Nenhum usuario encontrado</td></tr>';
        return;
    }
    tbody.innerHTML = users.map(u => {
        const roles = (u.roles || []).map(r => `<span class="badge badge-blue">${r}</span>`).join(' ');
        const verified = u.is_verified
            ? '<span class="badge badge-green">Sim</span>'
            : '<span class="badge badge-red">Nao</span>';
        const status = u.is_active !== false
            ? '<span class="badge badge-green">Ativo</span>'
            : '<span class="badge badge-red">Inativo</span>';
        return `<tr>
            <td>${esc(u.name)}</td>
            <td>${esc(u.email)}</td>
            <td>${roles}</td>
            <td>${verified}</td>
            <td>${status}</td>
            <td>${fmtDate(u.created_at)}</td>
            <td class="actions-cell">
                <button class="btn-sm btn-primary" onclick="editUser('${u.id}','${esc(u.name)}','${esc(u.email)}')">Editar</button>
                <button class="btn-sm btn-warning" onclick="toggleStatus('${u.id}', ${u.is_active !== false})">${u.is_active !== false ? 'Desativar' : 'Ativar'}</button>
                <button class="btn-sm btn-primary" onclick="openRolesModal('${u.id}', ${JSON.stringify(u.roles || []).replace(/"/g, '&quot;')})">Roles</button>
                <button class="btn-sm btn-danger" onclick="deleteUser('${u.id}','${esc(u.name)}')">Excluir</button>
            </td>
        </tr>`;
    }).join('');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function editUser(id, name, email) {
    document.getElementById('editUserId').value = id;
    document.getElementById('editUserName').value = name;
    document.getElementById('editUserEmail').value = email;
    openModal('editUserModal');
}

async function saveUser() {
    const id = document.getElementById('editUserId').value;
    const name = document.getElementById('editUserName').value.trim();
    const email = document.getElementById('editUserEmail').value.trim();
    if (!name || !email) return toast('Preencha todos os campos', 'error');
    try {
        await api(`/users/${id}`, { method: 'PUT', body: JSON.stringify({ name, email }) });
        toast('Usuario atualizado');
        closeModal('editUserModal');
        loadUsers(usersPage);
        loadStats();
    } catch (e) { toast(e.message, 'error'); }
}

async function toggleStatus(id, currentlyActive) {
    const action = currentlyActive ? 'desativar' : 'ativar';
    if (!confirm(`Deseja ${action} este usuario?`)) return;
    try {
        await api(`/users/${id}/status`, { method: 'PUT', body: JSON.stringify({ is_active: !currentlyActive }) });
        toast(`Usuario ${action === 'desativar' ? 'desativado' : 'ativado'}`);
        loadUsers(usersPage);
        loadStats();
    } catch (e) { toast(e.message, 'error'); }
}

async function deleteUser(id, name) {
    if (!confirm(`Tem certeza que deseja EXCLUIR o usuario "${name}"? Esta acao e irreversivel.`)) return;
    try {
        await api(`/users/${id}`, { method: 'DELETE' });
        toast('Usuario excluido');
        loadUsers(usersPage);
        loadStats();
    } catch (e) { toast(e.message, 'error'); }
}

// -- Roles modal --------------------------------------------------------------

async function openRolesModal(userId, currentRoles) {
    document.getElementById('rolesUserId').value = userId;
    if (!allRoles.length) {
        try {
            const { data } = await api('/roles');
            allRoles = data.roles;
        } catch { return toast('Erro ao carregar roles', 'error'); }
    }
    const container = document.getElementById('rolesCheckboxes');
    container.innerHTML = allRoles.map(r => {
        const checked = currentRoles.includes(r.name) ? 'checked' : '';
        return `<div class="form-group" style="margin-bottom:.4rem">
            <label><input type="checkbox" value="${r.name}" ${checked} /> ${r.name} <small style="color:#888">â€” ${r.description || ''}</small></label>
        </div>`;
    }).join('');
    openModal('rolesModal');
}

async function saveRoles() {
    const userId = document.getElementById('rolesUserId').value;
    const checked = [...document.querySelectorAll('#rolesCheckboxes input:checked')].map(c => c.value);
    if (!checked.length) return toast('Selecione pelo menos um role', 'error');
    try {
        await api(`/users/${userId}/roles`, { method: 'PUT', body: JSON.stringify({ roles: checked }) });
        toast('Roles atualizados');
        closeModal('rolesModal');
        loadUsers(usersPage);
    } catch (e) { toast(e.message, 'error'); }
}

// -- Canvas -------------------------------------------------------------------

let canvasPage = 1;
let canvasSearchTerm = '';

async function loadCanvas(page = 1) {
    canvasPage = page;
    try {
        const params = new URLSearchParams({ page, limit: 15 });
        if (canvasSearchTerm) params.set('search', canvasSearchTerm);
        const { data } = await api(`/canvas?${params}`);
        renderCanvasTable(data.canvas);
        renderPagination('canvasPagination', data.pagination, loadCanvas);
    } catch (e) { toast(e.message, 'error'); }
}

function renderCanvasTable(list) {
    const tbody = document.getElementById('canvasTableBody');
    if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;padding:2rem">Nenhum canvas encontrado</td></tr>';
        return;
    }
    tbody.innerHTML = list.map(c => {
        const pub = c.is_public ? '<span class="badge badge-green">Sim</span>' : '<span class="badge badge-gray">Nao</span>';
        const type = `<span class="badge badge-blue">${c.canvas_type.toUpperCase()}</span>`;
        return `<tr>
            <td>${esc(c.title)}</td>
            <td>${type}</td>
            <td>${esc(c.author_name)} <small style="color:#888">${esc(c.author_email)}</small></td>
            <td>${pub}</td>
            <td>${fmtDate(c.updated_at)}</td>
            <td><button class="btn-sm btn-danger" onclick="deleteCanvas('${c.id}','${esc(c.title)}')">Excluir</button></td>
        </tr>`;
    }).join('');
}

async function deleteCanvas(id, title) {
    if (!confirm(`Excluir canvas "${title}"?`)) return;
    try {
        await api(`/canvas/${id}`, { method: 'DELETE' });
        toast('Canvas excluido');
        loadCanvas(canvasPage);
        loadStats();
    } catch (e) { toast(e.message, 'error'); }
}

// -- Roles listing ------------------------------------------------------------

async function loadRoles() {
    try {
        const { data } = await api('/roles');
        allRoles = data.roles;
        const container = document.getElementById('rolesContainer');
        container.innerHTML = data.roles.map(r => {
            const perms = (r.permissions || [])
                .map(p => `<span class="badge badge-blue">${p.resource}:${p.action}</span>`)
                .join(' ');
            return `<div class="role-card">
                <h3>${esc(r.name)}</h3>
                <p>${esc(r.description || '')}</p>
                <div class="perm-list">${perms || '<span style="color:#888">Sem permissoes</span>'}</div>
            </div>`;
        }).join('');
    } catch (e) { toast(e.message, 'error'); }
}

// -- Pagination ---------------------------------------------------------------

function renderPagination(containerId, pag, loadFn) {
    const el = document.getElementById(containerId);
    if (pag.pages <= 1) { el.innerHTML = ''; return; }
    let html = `<button ${pag.page <= 1 ? 'disabled' : ''} onclick="(${loadFn.name})(${pag.page - 1})">Anterior</button>`;
    for (let i = 1; i <= pag.pages; i++) {
        html += `<button class="${i === pag.page ? 'active' : ''}" onclick="(${loadFn.name})(${i})">${i}</button>`;
    }
    html += `<button ${pag.page >= pag.pages ? 'disabled' : ''} onclick="(${loadFn.name})(${pag.page + 1})">Proximo</button>`;
    el.innerHTML = html;
}

// -- Tabs ---------------------------------------------------------------------

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`panel-${btn.dataset.tab}`).classList.add('active');
    });
});

// -- Search -------------------------------------------------------------------

document.getElementById('userSearch').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => { usersSearch = e.target.value; loadUsers(1); }, 350);
});

document.getElementById('canvasSearch').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => { canvasSearchTerm = e.target.value; loadCanvas(1); }, 350);
});

// -- Init ---------------------------------------------------------------------

(async function init() {
    await checkAdmin();
    loadStats();
    loadUsers();
    loadCanvas();
    loadRoles();
})();
</script>
</body>
</html>
